name: Backend CI/CD

on:
  pull_request:
  push:
    branches:
      - main
  workflow_dispatch:

permissions:
  contents: read
  packages: write

concurrency:
  group: backend-${{ github.ref }}
  cancel-in-progress: true

env:
  PYTHON_VERSION: "3.12"
  IMAGE_NAME: ghcr.io/nero-service/sausalito-be
  GHCR_DEPLOY_USERNAME: pump9918

jobs:
  test:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: pip
          cache-dependency-path: requirements/local.txt

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements/local.txt

      - name: Install ripgrep
        run: |
          sudo apt-get update
          sudo apt-get install -y ripgrep

      - name: Run security checks
        run: ./scripts/check_sensitive.sh

      - name: Run tests
        run: python manage.py test --verbosity 2
        env:
          DJANGO_SETTINGS_MODULE: config.settings.local
          DJANGO_DEBUG: "true"
          DJANGO_SECRET_KEY: ci-secret-key
          DB_ENGINE: sqlite3

      - name: Validate compose configuration
        run: |
          cp .env.prod.example .env.prod
          docker compose config > /tmp/docker-compose.validated.yaml
          rm -f .env.prod

      - name: Validate production env template
        run: ./scripts/validate_env_prod.sh --file .env.prod.example --template

      - name: Validate shell scripts syntax
        run: |
          bash -n scripts/check_sensitive.sh
          bash -n scripts/validate_env_prod.sh
          bash -n scripts/predeploy_check.sh
          bash -n scripts/deploy_backend.sh
          bash -n scripts/ssl/bootstrap_letsencrypt.sh
          bash -n scripts/ssl/renew_letsencrypt.sh
          bash -n scripts/ssl/enable_https_conf.sh
          bash -n scripts/systemd/install_runtime_automation.sh
          bash -n scripts/maintenance/prune_docker.sh
          bash -n scripts/maintenance/disk_guard.sh
          bash -n scripts/maintenance/runtime_guard.sh
          bash -n scripts/maintenance/backup_guard.sh
          bash -n scripts/maintenance/backup_postgres_to_object_storage.sh

  build-and-push:
    if: github.event_name != 'pull_request'
    runs-on: ubuntu-latest
    needs: test
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Login to GHCR
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ env.GHCR_DEPLOY_USERNAME }}
          password: ${{ secrets.GHCR_TOKEN }}

      - name: Setup Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build and push image
        uses: docker/build-push-action@v6
        with:
          context: .
          file: ./Dockerfile
          push: true
          tags: |
            ${{ env.IMAGE_NAME }}:${{ github.sha }}
            ${{ env.IMAGE_NAME }}:latest
          cache-from: type=gha
          cache-to: type=gha,mode=max

  deploy:
    if: github.event_name != 'pull_request' && github.ref == 'refs/heads/main'
    runs-on: ubuntu-latest
    needs: build-and-push
    environment: production
    steps:
      - name: Validate required deploy secrets
        env:
          DEPLOY_HOST: ${{ secrets.DEPLOY_HOST }}
          DEPLOY_USER: ${{ secrets.DEPLOY_USER }}
          DEPLOY_PORT: ${{ secrets.DEPLOY_PORT }}
          DEPLOY_PATH: ${{ secrets.DEPLOY_PATH }}
          DEPLOY_SSH_KEY_RAW: ${{ secrets.DEPLOY_SSH_KEY }}
          GHCR_TOKEN: ${{ secrets.GHCR_TOKEN }}
        run: |
          set -euo pipefail
          : "${DEPLOY_HOST:?DEPLOY_HOST is required}"
          : "${DEPLOY_USER:?DEPLOY_USER is required}"
          : "${DEPLOY_PORT:?DEPLOY_PORT is required}"
          : "${DEPLOY_PATH:?DEPLOY_PATH is required}"
          : "${GHCR_TOKEN:?GHCR_TOKEN is required}"
          : "${DEPLOY_SSH_KEY_RAW:?DEPLOY_SSH_KEY is required}"
          if ! grep -q "BEGIN .*PRIVATE KEY" <<<"${DEPLOY_SSH_KEY_RAW}"; then
            echo "::error::DEPLOY_SSH_KEY must be a private key (BEGIN ... PRIVATE KEY)."
            exit 1
          fi

      - name: Deploy via SSH
        uses: appleboy/ssh-action@v1.2.0
        with:
          host: ${{ secrets.DEPLOY_HOST }}
          username: ${{ secrets.DEPLOY_USER }}
          key: ${{ secrets.DEPLOY_SSH_KEY }}
          passphrase: ${{ secrets.DEPLOY_SSH_PASSPHRASE }}
          port: ${{ secrets.DEPLOY_PORT }}
          timeout: 30s
          command_timeout: 20m
          script_stop: true
          script: |
            set -euo pipefail
            cd ${{ secrets.DEPLOY_PATH }}
            export GHCR_TOKEN="${{ secrets.GHCR_TOKEN }}"
            export GHCR_DEPLOY_USERNAME="${{ env.GHCR_DEPLOY_USERNAME }}"
            export BACKEND_IMAGE=${{ env.IMAGE_NAME }}
            export IMAGE_TAG=${{ github.sha }}
            git pull --ff-only origin main
            echo "${GHCR_TOKEN}" | docker login ghcr.io -u "${GHCR_DEPLOY_USERNAME}" --password-stdin
            ./scripts/deploy_backend.sh
